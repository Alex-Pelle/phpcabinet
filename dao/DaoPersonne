<?php

class DaoPersonne implements Dao {

    private final Connexion $connexion = Connexion::getInstance();

function getAll() {
    $pdo = $this->connexion->getPDO();
    $getAll = $pdo->query('SELECT * FROM Personne');
    $tableauSortie = $getAll->fetchAll(PDO::FETCH_ASSOC);
    return $tableauSortie;
}

function getAllUsagers() {
    $pdo = $this->connexion->getPDO();
    $getAll = $pdo->query('SELECT * FROM Personne WHERE fonction != "M"');
    $tableauSortie = $getAll->fetchAll(PDO::FETCH_ASSOC);
    return $tableauSortie;
}

function getAllMedecins() {
    $pdo = $this->connexion->getPDO();
    $getAll = $pdo->query('SELECT * FROM Personne WHERE fonction != "U"');
    $tableauSortie = $getAll->fetchAll(PDO::FETCH_ASSOC);
    return $tableauSortie;
}

function getById($cle) {
    $pdo = $this->connexion->getPDO();
    $getById = $pdo->query("SELECT * FROM Personne WHERE idPersonne = $cle");
    $sortie = $getById->fetch(PDO::FETCH_ASSOC);
    return $sortie;
}

function insert($item) {
    $pdo = $this->connexion->getPDO();
    $insert = $pdo->prepare('INSERT INTO 
        Personne(fonction,nomPersonne,prenomPersonne,civilite,Adresse,code_postal,ville,numero_securite,idMedecin) 
            VALUES
            (:fonction,:nomPersonne,:prenomPeronne,:civilite,:Adresse,:code_postal,:ville,:numero_securite,:idMedecin)'
    );

    if($item instanceof Medecin) {
        $insert->execute(array(
            'fonction' => 'M',
            'nomPersonne' => $item->getPersonne()->getNom(),
            'prenomPersonne' => $item->getPersonne()->getPrenom(),
            'civilite' => $item->getPersonne()->getCivilite()->name,
            'Adresse' => NULL,
            'code_postal' => NULL,
            'ville' => NULL,
            'numero_securite' => NULL,
            'idMedecin' => NULL
        ));
    }

    if($item instanceof Usager) {
        $insert->execute(array(
            'fonction' => 'U',
            'nomPersonne' => $item->getPersonne()->getNom(),
            'prenomPersonne' => $item->getPersonne()->getPrenom(),
            'civilite' => $item->getPersonne()->getCivilite()->name,
            'Adresse' => $item->getAdresse(),
            'code_postal' => $item->getCode_postal(),
            'ville' => $item->getVille(),
            'numero_securite' => $item->getNumero_securite(),
            'idMedecin' => $item->getMedecinReferant()->getPersonne()->getIdPersonne()
        ));
    }
   

}

function update($item) {
    $nom = $item->getPersonne()->getNom();
    $prenom = $item->getPersonne()->getPrenom();
    $civilite = $item->getPersonne()->getCivilite()->name;

    $pdo = $this->connexion->getPDO();
    $insert = $pdo->prepare('UPDATE Personne SET
        nomPersonne = :nomPersonne ,
        prenomPersonne = :prenomPersonne ,
        civilite =  :civilite ,
        Adresse = :adresse ,
        code_postal = :code_postal ,
        ville = :ville ,
        numero_securite = :numero_securite,
        idMedecin = :idMedecin
        WHERE idPersonne = :idPersonne ');

    $insert->bindParam(':nomPersonne',$nom , PDO::PARAM_STR);
    $insert->bindParam(':prenomPersonne',$prenom ,PDO::PARAM_STR);
    $insert->bindParam(':civilite',$civilite,PDO::PARAM_STR);

    if($item instanceof Medecin) {
        $null=NULL;
        $insert->bindParam(':adresse',$null , PDO::PARAM_STR);
        $insert->bindParam(':code_postal',$null ,PDO::PARAM_STR);
        $insert->bindParam(':ville',$null,PDO::PARAM_STR);
        $insert->bindParam(':numero_securite',$null , PDO::PARAM_STR);
        $insert->bindParam(':idMedecin',$null ,PDO::PARAM_INT);
    }

    if($item instanceof Usager) {
        $adresse = $item->getAdresse();
        $code_postal = $item->getCode_postal();
        $ville = $item->getVille();
        $numero_securite = $item->getNumero_securite();
        $idMedecin = $item->getPersonne()->getIdPersonne();

        $insert->bindParam(':adresse',$adresse , PDO::PARAM_STR);
        $insert->bindParam(':code_postal',$code_postal ,PDO::PARAM_STR);
        $insert->bindParam(':ville',$ville,PDO::PARAM_STR);
        $insert->bindParam(':numero_securite',$numero_securite , PDO::PARAM_STR);
        $insert->bindParam(':idMedecin',$idMedecin ,PDO::PARAM_INT);
    }

    $insert->execute();
}
function delete($item) {

}

}

?>